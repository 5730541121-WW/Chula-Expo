<!-- Libery -->
<link rel="import" href="/public/lib/polymer/polymer.html">
<!-- Web Component -->
<link rel="import" href="/public/lib/app-route/app-route.html">
<link rel="import" href="/public/lib/vaadin-upload/vaadin-upload.html">
<link rel="import" href="/public/lib/paper-card/paper-card.html">
<link rel="import" href="/public/lib/paper-checkbox/paper-checkbox.html">
<link rel="import" href="/public/lib/paper-autocomplete/paper-autocomplete.html">
<link rel="import" href="/public/lib/paper-tags-input/paper-tags-input.html">
<link rel="import" href="/public/lib/paper-input/paper-textarea.html">
<link rel="import" href="/public/lib/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="/public/lib/greenyouse-datetime-local-input/datetime-local-input.html">
<link rel="import" href="/public/lib/google-map/google-map.html">
<link rel="import" href="/public/lib/google-map/google-map-marker.html">

<link rel="import" href="/components/shared-styles.html">

<dom-module id="activity-edit-page">
  <template>
    <style is="custom-style" include="shared-styles">
      :host {
        @apply(--layout-vertical);
        @apply(--layout-center-center);
        padding-top: 20px;
      }

      paper-card {
        width: 100%;
      }

      .item {
        margin-bottom: 10px;
      }
      .form-title {
        margin-bottom: 20px;
      }

      .avatar {
        display: inline-block;
        height: 40px;
        overflow: hidden;
        margin-right: 20px;
      }

      .flex-layout {
        @apply(--layout-horizontal);
      }
      .flex {
        @apply(--layout-flex);
      }
      .label {
        font-weight: 200;
        width: 100px;
        display: inline-block;
        margin-right: 20px;
      }
      .label.--upload {
        line-height: 70px;
      }

      .company {
        font-size: 20px;
        font-weight: 200;
      }

      google-map {
        height: 300px;
      }

			.button-holder {
        @apply(--layout-horizontal);
        @apply(--layout-end-justified);
        margin-top: 10px;
      }
    </style>
		<app-route
      route="{{route}}"
      pattern="/:activityId"
      data="{{routeData}}"
      tail="{{subroute}}"
    ></app-route>
    <iron-ajax
      id="activityGetId"
      url="{{urlId}}"
      on-response="_handleResponse"
      headers='{"Authentication": "{{token}}"}'
      handle-as="json"
    ></iron-ajax>
    <div class="container">
      <paper-card>
				<form is="iron-form" id="form" method="post" class="card-content"
					action="{{urlId}}" on-iron-form-presubmit="_presubmit" on-iron-form-response="_response">
					<div class="card-content">
						<!-- Thumbnail Upload -->
						<div class="item">
							<div class="flex-layout">
								<label class="label --upload">Thumbnail</label>
								<div class="flex">
									<vaadin-upload
										id="thumbnailUpload"
										accept="image/*"
										target="/upload/img/activities/thumbnail"
										method="POST"
										headers="{'Authorization': 'JWT {{token}}'}"
										form-data-name="picture"
									>
										<div class="drop-label">
											<iron-icon icon="image:collections"></iron-icon>
											รูปทัมเนล
										</div>
									</vaadin-upload>
									<input id="thumbnail" type="hidden" name="thumbnail">
									<script>
										var thumbnailUpload = document.querySelector('activity-edit-page').querySelector('vaadin-upload#thumbnailUpload');
										thumbnailUpload.addEventListener("upload-response", function(event) {
											document.querySelector('activity-edit-page').querySelector('#thumbnail').value = event;
										});
									</script>
								</div>
							</div>
						</div>
						<!-- Banner Upload -->
						<div class="item">
							<div class="flex-layout">
								<label class="label --upload">Banner</label>
								<div class="flex">
									<vaadin-upload
										id="bannerUpload"
										accept="image/*"
										target="/upload/img/activities/banner"
										method="POST"
										headers="{'Authorization': 'JWT {{token}}'}"
										form-data-name="picture"
									>
										<div class="drop-label">
											<iron-icon icon="image:collections"></iron-icon>
											แบรนเนอร์
										</div>
									</vaadin-upload>
								</div>
							</div>
						</div>
						<!-- Time -->
						<div class="item">
							<div>
								<label class="label --input">Start Time</label>
								<div class="flex" style="display: inline-block">
									<datetime-local-input name="start" label="" no-label-float="true"></datetime-local-input>
								</div>
							</div>
							<div>
								<label class="label --input">End Time</label>
								<div class="flex" style="display: inline-block">
									<datetime-local-input name="end" label="" no-label-float="true" required></datetime-local-input>
								</div>
							</div>
						</div>

						<div class="item">
							<div>
								<label class="label --input">Contact</label>
								<div class="flex" style="display: inline-block">
									<paper-input type="text" value="{{activity.contact}}" name="contact" label="" no-label-float="true"></paper-input>
								</div>
							</div>
						</div>

						<div class="item">
							<div>
								<label class="label --input">Video Url</label>
								<div class="flex" style="display: inline-block">
									<paper-input type="text" value="{{activity.video}}" name="video" label="" no-label-float="true" required></paper-input>
								</div>
							</div>
							<div>
								<label class="label --input">PDF Url</label>
								<div class="flex" style="display: inline-block">
									<paper-input type="text" value="{{activity.pdf}}" name="pdf" label="" no-label-float="true" required></paper-input>
								</div>
							</div>
							<div>
								<label class="label --input">Link</label>
								<div class="flex" style="display: inline-block">
									<paper-input type="text" value="{{activity.link}}" name="link" label="" no-label-float="true" required></paper-input>
								</div>
							</div>

						</div>

						<!-- Zone -->
						<div class="item">
							<label class="label --upload">Zone</label>
							<div class="flex" style="display: inline-block">
								<paper-autocomplete name="zone" label="Zone" id="input-zone" no-label-float="true" remote-source="true"></paper-autocomplete>
							</div>
							<script>
								document.querySelector('activity-edit-page').querySelector('#input-zone').addEventListener('autocomplete-change', function(event) {
									var input = this;
									var search = event.detail.option.text;
									var url = '/api/zones?nameEN=' + search;
									var delay = Math.random() * (500 - 100) + 100;

									setTimeout(function () {
										var req = new XMLHttpRequest();
										req.open('GET',encodeURI(url));
										req.onload = function() {
											if (req.status === 200) {
												var data = JSON.parse(req.response);
												var arr = data.results.map(function(obj){
													return { text:obj.name.en, value:obj['_id'] };
												});
												input.suggestions(arr);
											}
										};
										req.send();
									}.bind(this), delay);
								});
							</script>
						</div>

						<!-- Location -->
						<div class="item">
							<label class="label --input">Location</label>
							<div class="" style="display: inline-block">
								<paper-autocomplete name="locationPlace" label="Location" id="input-location" no-label-float="true" remote-source="true"></paper-autocomplete>
							</div>
							<script>
								document.querySelector('activity-edit-page').querySelector('#input-location').addEventListener('autocomplete-change', function(event) {
									var input = this;
									var search = event.detail.option.text;
									var url = '/api/places?nameEN=' + search;
									var delay = Math.random() * (500 - 100) + 100;

									setTimeout(function () {
										var req = new XMLHttpRequest();
										req.open('GET',encodeURI(url));
										req.onload = function() {
											if (req.status === 200) {
												var data = JSON.parse(req.response);
												var arr = data.results.map(function(obj){
													return { text:obj.name.en, value:obj['_id'] };
												});
												input.suggestions(arr);
											}
										};
										req.send();
									}.bind(this), delay);
								});
							</script>
							<div>
								<label class="label --input">Floor</label>
								<div class="flex" style="display: inline-block">
									<paper-input type="text" value="{{activity.location.floor}}" name="locationFloor" label="" no-label-float="true"></paper-input>
								</div>
							</div>
							<div>
								<label class="label --input">Room</label>
								<div class="flex" style="display: inline-block">
									<paper-input type="text" value="{{activity.location.room}}" name="locationRoom" label="" no-label-float="true"></paper-input>
								</div>
							</div>
						</div>

						<div class="item">
							<div>
								<label class="label --input">HighLight</label>
								<div class="flex" style="display: inline-block">
									<paper-checkbox name="isHighlight" label="" no-label-float="true" ></paper-checkbox>
								</div>
							</div>
						</div>

						<!-- Google Map -->
						<div class="item">
							<google-map latitude="[[activity.location.latitude]]" longitude="[[activity.location.longitude]]" zoom="[[zoom]]" api-key="AIzaSyDqaDUBa0p8qYiWDwjYUlxkInJuwgTxD1o">
								<google-map-marker latitude="{{activity.location.latitude}}" longitude="{{activity.location.longitude}}" draggable="true"
										title="Activity Location!"></google-map-marker>
							</google-map>
						</div>
					</div>
					<div class="card-content">
						<!-- Thai Language -->
						<div class="flex-layout center form-title">
							<div class="avatar" item-icon><img src="/public/img/th.png" /></div>
							<div class="flex company">ภาษาไทย</div>
						</div>
						<paper-input type="text" label="ชื่อกิจกรรม" value="{{activity.name.th}}" name="nameTH" always-float-label></paper-input>
						<paper-input type="text" label="รายละเอียดย่อ" value="{{activity.shortDescription.th}}" name="shortDescriptionTH" char-counter maxlength="80" always-float-label></paper-input>
						<paper-textarea label="รายละเอียด" value="{{activity.description.th}}" name="descriptionTH" rows="4" always-float-label></paper-textarea>
						<!-- English Language -->
						<div class="flex-layout center form-title">
							<div class="avatar" item-icon><img src="/public/img/en.png" /></div>
							<div class="flex company">English</div>
						</div>
						<paper-input type="text" label="Activity name" value="{{activity.name.en}}" name="nameEN" always-float-label></paper-input>
						<paper-input type="text" label="Short description" value="{{activity.shortDescription.en}}" name="shortDescriptionEN" char-counter maxlength="80" always-float-label></paper-input>
						<paper-textarea label="Description" value="{{activity.description.en}}" name="descriptionEN" rows="4" always-float-label></paper-textarea>
					</div>
					<div class="card-content">
						<vaadin-upload
							id="activityImage"
							accept="image/*"
							target="/upload/img/activities"
							method="POST"
							headers="{'Authorization': 'JWT {{token}}'}"
							form-data-name="picture"
						>
							<div class="drop-label">
								<iron-icon icon="image:collections"></iron-icon>
								รูปประกอบกิจกกรม
							</div>
						</vaadin-upload>
						<!-- Tags -->
						<div class="item">
							<paper-tags-input label="Tags" tags="{{tags_list}}"></paper-tags-input>
						</div>
					</div>

					<!-- Submit Button -->
					<div class="card-actions">
						<div class="button-holder">
							<paper-button on-click="_delayedSubmit">
								<paper-spinner id="spinner" hidden></paper-spinner>Edit
							</paper-button>
						</div>
					</div>
				</form>
      </paper-card>
    </div>
  </template>
  <script>
    Polymer({
      is: 'activity-edit-page',
      properties: {
        urlId: {
          type: Object,
          value: ''
        },
        token: {
          type: String,
        },
        zoom: {
          type: Number,
          value: 16
        },
        route: {
          type: String,
        },
        activity: {
          type: Object,
        }
      },
      observers: [
        '_routeIdChanged(routeData.activityId)',
      ],
      _routeIdChanged: function(activityId) {
        if(!!activityId){
          this.urlId = `/api/activities/${activityId}`;
          this.$.activityGetId.generateRequest();
        }
      },
      _delayedSubmit: function(event) {
        var form = this.$.form;
        this.$.spinner.active = true;
        this.$.spinner.hidden = false;
        this.$.form.disabled = true;
        // Simulate a slow server response.
        setTimeout(function() {
          form.submit();
        }, 1000);
      },
      _response: function(e) {
        if (e.detail.response.success) {
          window.location = '/activity/show/' + this.routeData.activityId;
        }
      },
      _presubmit: function(event) {
        this.$.form.request.method = 'put';
      	this.$.form.request.body.locationLat = this.activity.location.latitude;
				this.$.form.request.body.locationLong = this.activity.location.longitude;
      },
      _handleResponse: function(event) {
        if (event.detail.response.success) {
          this.activity = event.detail.response.results;
        } else {
          this.error = event.detail.response.errors;
        }
      }
    })
  </script>
</dom-module>
